name: Update Game Data

on:
  schedule:
    - cron: '0 0 * * *' # Runs at 00:00 UTC every day
  workflow_dispatch:

jobs:
  update-game-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for updates
        id: check
        run: |
          CURRENT=$(git rev-parse HEAD:xiv-gen/ffxiv-datamining)
          REMOTE=$(git ls-remote https://github.com/xivapi/ffxiv-datamining.git master | awk '{print $1}')
          
          if [ "$CURRENT" = "$REMOTE" ]; then
            echo "No updates found."
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "Updates found!"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Update Submodule
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git submodule update --remote --merge xiv-gen/ffxiv-datamining

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update game data"
          title: "chore: update game data"
          body: |
            Updates `xiv-gen/ffxiv-datamining` submodule to the latest version.
            
            This PR is auto-generated by the [Update Game Data](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.
          branch: update-game-data
          delete-branch: true
          base: master
